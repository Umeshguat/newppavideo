<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerJS Video Call with Camera Toggle</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        video { width: 45%; border: 2px solid black; margin: 5px; }
        button { margin: 5px; padding: 10px; font-size: 16px; }
    </style>
</head>
<body>

    <h2>Your Peer ID: <span id="my-peer-id">Generating...</span></h2>
    <input type="text" id="remote-peer-id" placeholder="Enter Remote Peer ID">
    <button onclick="callPeer()">Call</button>

    <div>
        <video id="myVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <button id="toggleCamera">Toggle Camera</button>

    <script>
        const peer = new Peer(); // Create PeerJS instance
        let localStream;
        let currentCall;
        let cameraEnabled = true;

        // Get and display the Peer ID
        peer.on('open', id => {
            document.getElementById('my-peer-id').innerText = id;
        });

        // Function to start the camera
        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('myVideo').srcObject = localStream;
                console.log("Camera started");

                if (currentCall) {
                    currentCall.peerConnection.getSenders().forEach(sender => {
                        if (sender.track.kind === 'video') {
                            sender.replaceTrack(localStream.getVideoTracks()[0]);
                        }
                    });
                }
            } catch (err) {
                console.error("Error accessing camera:", err);
            }
        }

        // Function to stop the camera (revoke permission)
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop()); // Completely stop video and audio
                localStream = null;
                document.getElementById('myVideo').srcObject = null;
                console.log("Camera stopped");
            }
        }

        // Handle incoming calls
        peer.on('call', call => {
            call.answer(localStream);
            currentCall = call;
            call.on('stream', remoteStream => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
        });

        // Make a call
        function callPeer() {
            const remotePeerId = document.getElementById('remote-peer-id').value;
            if (!remotePeerId) return alert("Enter a remote Peer ID");

            const call = peer.call(remotePeerId, localStream);
            currentCall = call;

            call.on('stream', remoteStream => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
        }

        // Toggle Camera (Stop and Restart with Permission)
        document.getElementById('toggleCamera').addEventListener('click', async () => {
            if (cameraEnabled) {
                stopCamera(); // Turn off camera
            } else {
                await startCamera(); // Request permission again
            }
            cameraEnabled = !cameraEnabled;
        });

        // Start camera automatically when the page loads
        startCamera();
    </script>

</body>
</html>   